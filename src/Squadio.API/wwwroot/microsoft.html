<html lang="en">
<head>
    <title>Auth by microsoft account</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js" class="pre"></script>
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.0/js/msal.min.js"></script>
</head>
<body>
<script>
    const msalConfig = {
        auth: {
            clientId: 'e0b221ed-d1ab-42b9-a33d-16410a9572ee'
        },
        cache: {
            cacheLocation: "localStorage",
            storeAuthStateInCookie: true
        }
    };

    const graphConfig = {
        graphMeEndpoint: "https://graph.microsoft.com/v1.0/me"
    };

    const requestObj = {
        scopes: ["User.Read"]
    };

    const myMSALObj = new Msal.UserAgentApplication(msalConfig);
    myMSALObj.handleRedirectCallback(function (error, response) {
        if (error) {
            console.error("handleCallback error: ", response);
        } else {
            console.log("handleCallback response: ", response);
        }
    });

    document.addEventListener("DOMContentLoaded", function (event) {
        let token = localStorage.getItem("msal.idtoken");
        console.log("on document ready");
        if (token != null) {
            if (token.length > 0) {
                validate();
            }
        }
    });
</script>
<script>
    function logIn() {

        myMSALObj.loginPopup(requestObj)
            .then(function (response) {
                acquireTokenPopupAndCallMSGraph();
                console.log("loginPopup response: ", response);
            })
            .catch(function (err) {
                console.error("loginPopup error: ", err);
            });
    }

    function logOut() {
        localStorage.clear();
        myMSALObj.logout();
    }

    function acquireTokenPopupAndCallMSGraph() {
        //Always start with acquireTokenSilent to obtain a token in the signed in user from cache
        myMSALObj.acquireTokenSilent(requestObj).then(function (tokenResponse) {
            console.log("Access token: ", tokenResponse.accessToken);
            callMSGraph(graphConfig.graphMeEndpoint, tokenResponse.accessToken, graphAPICallback);
        }).catch(function (error) {
            console.log(error);
            // Upon acquireTokenSilent failure (due to consent or interaction or login required ONLY)
            // Call acquireTokenPopup(popup window)
            if (requiresInteraction(error.errorCode)) {
                myMSALObj.acquireTokenPopup(requestObj).then(function (tokenResponse) {
                    console.log("Access token: ", tokenResponse.accessToken);
                    callMSGraph(graphConfig.graphMeEndpoint, tokenResponse.accessToken, graphAPICallback);
                }).catch(function (error) {
                    console.log(error);
                });
            }
        });
    }

    function callMSGraph(theUrl, accessToken) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function () {
            try {
                console.log(JSON.parse(this.responseText));
            }
            catch (e) {
                
            }
        };
        xmlHttp.open("GET", theUrl, true); // true for asynchronous
        xmlHttp.setRequestHeader('Authorization', 'Bearer ' + accessToken);
        xmlHttp.send();
    }

    function graphAPICallback(data) {
        document.getElementById("json").innerHTML = JSON.stringify(data, null, 2);
    }

    function validate() {
        var id_token = localStorage.getItem("msal.idtoken");

        console.log("-----------------");

        for (item in localStorage) {
            if (item.toString().includes(msalConfig.auth.clientId) && item.toString().includes(requestObj.scopes)) {
                var tokenInfo = JSON.parse(localStorage[item]);
                id_token = tokenInfo.accessToken;
                break;
            }
        }
        console.log("-----------------");

        var xhr = new XMLHttpRequest();

        var body = JSON.stringify({
            token: id_token
        });

        xhr.open('POST', 'http://localhost:5005/api/auth/token/microsoft');
        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.onload = function () {
            var result = JSON.parse(xhr.responseText);
            console.log(result);
        };

        xhr.send(body);
    }
</script>


<h2>Welcome to MSAL.js Quickstart</h2><br/>
<h4 id="WelcomeMessage"></h4>
<button id="LogIn" onclick="logIn()">LogIn</button>
<hr>
<button id="validate" onclick="validate()">Backend validation</button>
<hr>
<button id="LogOut" onclick="logOut()">LogOut</button>
<hr>
<pre id="json"></pre>
</body>
</html>